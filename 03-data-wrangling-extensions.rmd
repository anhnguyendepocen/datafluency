---
title: 'Data wrangling: Extension Exercises'
author: 'Ben Whalley'
date: "September 2020"
bibliography: [references.bib]
biblio-style: apa6
link-citations: yes
output: 
  webex::html_clean:
    includes:
      after_body: footer.html
---


```{r, echo=F, include=F}
knitr::opts_chunk$set(echo = TRUE, collapse=TRUE, cache=TRUE, comment=">", message=FALSE)
library(tidyverse)
library(webex)
library(pander)
theme_set(theme_minimal())
```


# RMarkdown

Markdown is a simple **text format** which can include writing, tables and images (see
http://commonmark.org/help/).

An RMarkdown document mixes R code with Markdown. You can generate images (plots) and tables
directly using R code.

In the language of RStudio, you **'knit'** your RMarkdown document to produce a finished document.
Knitting:

1. runs your code and
2. combines the analyses, graphs, with your explanatory text to
3. make a single pdf or html file.

This knitted file documents your work and can be shared easily with others.


#### Why use Rmarkdown?

Rmarkdown is becoming an important tool in the open science movement. Authors often share details of
their analysis in an Rmarkdown file because journal articles are too constrained to document this
properly.

A recent example from Plymouth is shared here: <https://zenodo.org/record/1120364>. This repository
includes:

-   The datafile in CSV format
-   The Rmarkdown source file
-   The knitted html document
    ([click here to have a look](media/whalley-andrade-data_supplement.html))

The [main assessment for this module](#assessment-authentic-analysis) requires you to make an Rmd
file like this to share a re-analysis of a published paper, so learning how to use Rmd is an
important part of the course.



## Creating a fresh RMarkdown file

The easiest way to create and RMarkdown file is from the `File > New > RMarkdown` menu option:

![](media/newrmd.png)

It should look something like this when you've done it:

![A new Rmd file, from the RStudio template.](media/new_rmd_file.png)

**Explanation** We asked RStudio to create a new Rmd file. Rstudio makes the new file from a
template, and this shows off some of the main features of RMarkdown.

---

RMarkdown files have the file extensions `.rmd` and must to be saved before they can be 'knitted'.

:::{.exercise}

1. Create a new Rmd file and save it somewhere in your home directory on the Rstudio server (or the
   same place you saved your other R Script files).

1. Have a look through the example file created in RStudio. Have a guess at what each part does.

1. Press the 'knit' button in the RStudio interface and check the results.

:::


## Working with 'chunks' of R code

To include R code within RMarkdown we write 3 backticks followed by `{r}`.

We then write some R code, and close the chunk with 3 more backticks. This is what it looks like:

![A code chunk in the RMarkdown editor](media/r-code-chunk.png)

`r hide("Can't find the backtick on your keyboard?")`

![On windows](media/backtick-windows-uk.png)

![On a Mac](media/backtick-mac-uk.png)

`r unhide()`

:::{.exercise}

As you do this exercise, take care to get the right number of backticks, and your curly brackets
(`{}`) in the right place.

1. Create a new 'chunk' of R code which includes one of the plots you have made so far today. Use
   one of the built in datasets for now.

1. Make sure you add `library(tidyverse)` just above your plot code.

1. Press 'knit' again and check the result.

:::

:::{.tip}

If you are getting errors when adding a code chunk always check you have:

-   3 backticks, then `{r}`, then **start a new line**
-   Your R code comes next
-   Load any packages needed at the top of the first chunk.
-   3 more backticks, **on their own line**. These final 3 backticks **must** start at the beginning
    of the line, have no spaces in front of them, and nothing after them.

If you are still getting errors:

-   Read the error message - it can give a clue
-   Simplify everything (remove R code until it works, then try again)

Using libraries in chunks:

-   Load packages (e.g. `library(tidyverse)`) once at the top of the file.
-   Remember that RStudio knits code from top to bottom (so load packages **before** you use them)
-   R wipes it's memory each time it knits your file, so needs reminding. You only need to load the
    package in one chunk though (don't do it multiple times).

:::



## Working interactively with Rmarkdown

Rather than typing commands in the console, **you should now run code directly from your Rmd code
chunks**.

This makes it much easier to keep track of your work.

See this video for an example:

<iframe src="https://player.vimeo.com/video/225968925" width="640" height="400" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>

:::{.exercise}

1. Put your cursor (pointer) anywhere inside the new chunk you added, containing the R code for your
   plot. The chunk should look something like this:

![](media/rchunk2.png)

2.  Press the green 'run' button (a rightward pointing triangle) in the top right corner of the
    chunk. Where does the result appear?

3.  Change the R code in your chunk (e.g. make a different plot). Press 'run' again.

4) Write several lines of R code in your chunk. Put the cursor on one of the lines and press
   `ctrl+enter` or `cmd+enter` if you are on a mac. Does this run all of the code in the chunk, or
   just part of it?

5. Write some code which uses `summarise` inside your code chunk to produce a table

:::


## Make your own RMarkdown document


:::{.exercise}

If you did not previously complete the plotting task (in the extensions) using the Berkley admissions data, do that now.

Create an RMarkdown file to report your analyses of the Berkley data. It should:

- Load the data and packages needed
- Use section headings (i.e. use the `#` or `##` to create a 1st or 2nd level heading)
- Include 2 or 3 plots
- Include text describing your conclusions  on the main question (was the admissions system 'fair')

When you are finished, knit the Rmd document to produce an html or PDF output (it's actually a good idea to knit regularly to pick up any errors).

:::




## Making nicer tables in RMarkdown

The `pander` function in the `pander` library can help make nicer tables when using RMarkdown.

For example, if we take a few rows from the Iris data they look like this:

```{r}
iris %>% head
```

But if we load the `pander` package, and use the `pander` command we get a nice table, like this:

```{r}
library(pander)
iris %>% head %>% pander
```

And we can add a caption to the table like this:

```{r}
iris %>% head %>% pander(caption="The first 6 rows from the iris dataset")
```

:::{.exercise}

Revisit one of the tasks that used [`group_by` + `summarise`](#cheat-group-summary). Use pander to
display the table in a nicer format, and knit your Rmarkdown file to pdf/html to see the results.

:::





# More on Long vs wide data


## Further reading

:::{.exercise}

To gain more understanding of the way the format of our data is important to the way we analyse it, read this article on wide/long data formats and the tradeoffs between the two: <https://www.theanalysisfactor.com/wide-and-long-data/>

:::




## Separating 'untidy' variables into tidy, long-form data:

The code below generates simulated data for 100 individuals at three time points. The format is
similar to the way you might record experimental data in a spreadsheet.

```{r}
N <- 20
repeatmeasuresdata <- tibble(person = 1:N,
  time_1 = rnorm(N),
  time_2 = rnorm(N, 1),
  time_3 = rnorm(N, 3))

repeatmeasuresdata %>% head
```

`repeatmeasuresdata` is in **wide** format. Each row contains data for one participant, and each
participant has three observations.

We can melt or reshape the data into longer format like so:

```{r}
repeatmeasuresdata %>%
  pivot_longer(starts_with("time")) %>%
  arrange(person, name) %>%
  head(8)
```

The problem we have now is that `name` contains text which describes at which time the
observation was made. We probably want a number for each timepoint, so we can make a plot with time
on the x axis.

The `separate` command separates a single character column (`name`) into multiple columns.
Rather than have a column with labels of the form 'time_1', it can create two columns, with labels
'time' and '1' in each.

```{r}
longrepeatmeasuresdata <- repeatmeasuresdata %>%
  pivot_longer(starts_with("time")) %>%
  separate(name, into = c("variable", "time"))

longrepeatmeasuresdata %>% head
```


Now the data are in long format, we can plot the points over time:

```{r}
longrepeatmeasuresdata %>%
  sample_n(30) %>%
  ggplot(aes(x=time, y=value)) +
  geom_point()
```



:::{.exercise}

This file contains sample contact and address data for 100 people: https://letterhub.com/wp-content/uploads/2018/03/100-contacts.csv


- Read the data into R
- Use the `separate` function to make a new variable which contains the *domain name* of these contacts' email address (e.g. yahoo.com, hotmail.com)

Use the `distinct` and/or `count` functions on the new variable you create containing the domain name. Look them up in the help file if you don't know which to use to answer these questions:

- How many different domains do the contacts have addresses with?
- How many people had a gmail account?
- Which domains had more than 10 users?


`r hide("Show workings")`


```{r}
contacts <- read_csv('https://letterhub.com/wp-content/uploads/2018/03/100-contacts.csv') %>% 
  separate(email, into=c("user", "domain"), sep ="@") 


# how many different domains
contacts %>% 
  distinct(domain) %>% 
  count()

# how many people use gmail
contacts %>% 
  count(domain) %>% 
  filter(domain=="gmail.com")

# which domains had more than 10 users?
contacts %>% 
  count(domain) %>% 
  filter(n > 10) 
```


`r unhide()`





:::






# More `pivot_longer` and plotting


:::{.exercise}

Use the `mtcars` data and facetting to produce these plots:

```{r, echo=F, message=F, warning=F}
mtcars %>%
  select(mpg, wt, disp) %>%
  pivot_longer(everything()) %>% 
  mutate(variable=Hmisc::capitalize(as.character(name))) %>%
  ggplot(aes(value, y=..scaled..)) +
  geom_density() +
  facet_wrap(~variable, scales="free_x") +
  labs(x="", y="Scaled density")
```

```{r, echo=F}
mtcars %>%
  select(mpg, wt, disp) %>%
  pivot_longer(everything()) %>% 
  mutate(variable=Hmisc::capitalize(as.character(name))) %>%
  ggplot(aes(value)) +
  geom_histogram(bins=7) +
  facet_wrap(~variable, scales="free_x") +
  labs(x="", y="Scaled density")
```

Some tips:

-   Add `scales="free_x"` to the `facet_wrap` function. So, it will read:
    `facet_wrap(~VARNAME, scales="free_x")`

-   For the histogram, replace `geom_density()` with `geom_histogram()`

-   Adjust the number of vertical bars in the histogram by adding `bins=7` (or some other number) to
    `geom_histogram()`

:::






# More practice

For more practice using these techniques for common problems in psychological research you could work through Andy Will's 'better tables' worksheet here: https://ajwills72.github.io/rminr/better-tables.html


------------


All content on this site distributed under a [Creative Commons](https://creativecommons.org/)
licence. CC-BY-SA 4.0.
